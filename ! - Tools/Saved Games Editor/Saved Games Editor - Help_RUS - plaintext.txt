 SaveGam?.* Editor

Цели и задачи

	Эта программа писалась для редактирования карт игры Wolfenstein 3-D и многочисленных 
продолжений, созданных на ее движке. Редактирование это ни в малой степени не напоминает 
читерство (ну кому нужно читерить в игре, которой скоро 15 лет стукнет?), но зато 
позволяет, за счет правки многих служебных переменных, писать карты с такими эффектами, 
на которые не способно стандартное редактирование.

Терминология

	SObj, или Вещь. Неподвижный предмет, такой, как лампа, колонна, обойма. Имеет клеточную 
систему координат.
	MObj, или Объект. Потенциально подвижный объект, такой, как живой или мертвый нацист, 
игрок, ракета. Имеет прецизионную систему координат.

Интерфейс


 1) Visspot ptr -- это указатель на место в таблице точек видимости. Это поле (0-й 
указатель) задает адрес начала таблицы в движке. Если вещь номер ноль имеет адекватную 
координатам точку видимости, её можно детектировать автоматически. Отсюда вывод: 
не назначайте нулевую вещь в качестве "односторонней" (см. п. 33).
 2) Obj ptr -- это указатель на объект. Они раскиданы по клеткам карты и указывают 
на объекты, которые хотя бы одним "углом" задевают эту клетку. Если таблица объектов 
не "корявая" и в ней, как положено, нулевой объект (игрок) не имеет на карте ссылки, 
а первый объект имеет, 0-й указатель можно детектировать автоматически. Отсюда вывод: 
если таблица подпортилась -- возьмите "образцовую" сохраненку того же движка и передерите 
в окошко правильное значение.
 3) Thing ptr -- это указатель на вещь. К сожалению, указатель на 0-ю вещь (начало 
таблицы) автодетектировать нельзя. Его нужно найти для каждого конкретного движка 
"методом тыка", так, чтоб не появлялись глючно-лишние вещи и не пропадали нужные 
(т.е. нужно знать карту). Умолчальный относится к одной из популярных версий Spear 
Of Destiny.
 -) Примечание. Неправильная (некратная размеру записи объекта, вещи и т.п.) установка 
полей окрашивает их в красный цвет. Разумеется, этот предупредительный индикатор 
может работать корректно только при загруженном, причем не битом, файле.
 4) Размер таблицы вещей. Необходим для "попадания в ногу" при чтении/записи сейва.

 5) Как известно, свободное пространство в Wolf3D разбито на "полы", или "зоны слышимости". 
Звук, произведенный в одной зоне, активирует противников в ней, даже если она простирается 
за пределы замкнутого помещения (именно так они слышат, скажем, сквозь стены и двери), 
и наоборот. Полы и прочие специальные клетки имеют номера старше стен, и обычно начинаются 
со ста седьмого номера. Если с другого -- можете подправить.
 6) Количество полов, отведенное на все про все.
 7) Это поле необходимо для ведения статистики прохождения предыдущих уровней. Оно 
хранит количество не-секретных уровней (т.е. тех, для которых считаются ratios) в 
одном эпизоде. Кстати, у той "популярной" версии Spear эта таблица "кривая" и имеет 
размер 8 (как в Wolf) вместо 20. Поэтому для нее нужно оставлять 8, а Spear -- не 
по нашей с вами вине -- неизбежно считает в конце averages криво.
 8) Число уровней в эпизоде. Необходимо для правильного поиска номера оригинальной 
карты в gamemaps.* и maphead.*.
 9) Загрузка карты. Карта загружается соответственно заданным в полях выше параметрам.

 10) Сохранение карты. Карта сохраняется, опять же, в вышеописанном формате. Можно 
ли конвертировать таким образом карты, подковырнув "в процессе" формат? Иногда. И 
сложно.
 11) Сама карта имеет несколько слоев: слой "неизменных", слой "стен", слой "вещей", 
слой "объектов" и слой "дверей". Слой "неизменных" содержит полы, поворотные точки, 
секреты и равную дребедень типа "выхода с эпизода с воплями". Увы, они не хранятся 
в сейве, редактор загружает их из gamemaps/maphead только для справки.
 Слой "стен" имеет два подслоя -- "как выглядит" и "кто стоит". Подслой "как выглядит" 
содержит номер графики стены. В конце этого списка идут двери, текстуру которых тоже 
на стенку налепить можно запросто. Дальше, с 64+номер стены, начинаются косяки. Нет, 
не баги, а то, куда уезжают двери. Которые сами начинаются со 128, причем первые 
64 обычные, а вторые -- секретные и номер обозначает номер графики стены. Если же 
стоит ноль, клетка выглядит пустой. Подслой "кто стоит" содержит номер препятствия. 
Если это ноль, препятствия нет -- даже если там графика стены, сквозь нее можно переть 
напролом. Навесьте занавеску-"соломку" и радуйтесь новому виду секретов. Ненулевые 
же величины соответствуют препятствию, которое может быть вещью (единица), стеной 
или косяком (от единицы до максимального номера стены; да-да, однозначностью тут 
и не пахнет), дверью (от 128 до 191) или объектом (большие величины, начиная с Obj 
0 ptr. Кармак лез на рожон,используя такие критерии).
 Слой "вещей" содержит вещи -- не матрицей 64х64, а списком с координатами. Соответственно, 
их не рисуют и стирают, а добавляют и удаляют. Количество их задается диапазоном 
"указатель на первую-указатель на последнюю". Указатель на первую фиксирован для 
каждого движка, так что "ползунком" служит последний указатель. Общий размер списка 
тоже фиксирован (обычно 400), "хвост" таблицы просто пропадает пустым.
 Слой "объектов" содержит объекты, хранимые примерно по тому же принципу, что и вещи. 
Разница только в том, что маркером "хвоста" служит не некая величина, а флаг "-1" 
в пункте "активен", да и пустоты за ним нет.
 Слой "двери" содержит 64 двери. Однако работают из них только младшие, те, которые 
были в оригинальной карте. Остальные представляют из себя ограниченно-рабочую декорацию. 
Причем лучше б совсем нерабочую.
 a) Цвет заливки клетки означает подслой "кто стоит". В данном случае перед нами 
стена без графики, невидимый барьер. "Отмазки" в виде вазы с цветами тоже нет... 
спишем нежелание героя выходить с уровня на дисциплину.
 b) Двубуквенное сочетание отражает номер текстуры. В данном случае перед нами обычная 
стена типа "пейзаж". Если буквы маленькие, значит, эта стена имеет номер текстуры+64 
и, следовательно, используется в качестве дверного косяка. Прилегающая к двери сторона 
приобретает текстуру "сталь-с-щелью". Также она может иметь цифровое обозначение 
-- от 0 до 63 это номер обычной двери, а от 64 до 127 -- номер секретной, она же 
pushwall; для секретной двери номер задает опять же текстуру.
 -) Левый клик или перемещение рамки стрелками рисуют стену, правый клик берет текущую 
за образец.
 c) Цвет рамки означает номер пола, относящийся к "неизменным". Если рамки нет, значит, 
в оригинале пола там не было и номер его -107 или что-то вроде. Точно не знаю, можно 
ли такие области сопрягать с дверьми (не будет ли при этом отрицательных индексов), 
но вроде Wolf перебирает инвалидные тайлы в заданном направлении, пока не встретит 
валидный.
 d) "Однозубая" стрелка означает поворотную точку. Она тоже "неизменна" и позволяет 
вам запускать патрули по некоторым маршрутам. Фантазируйте, например, пошлите солдата 
"в один конец" с открыванием двери, за которой сидит что-нибудь ОЧЕНЬ страшное. У 
игрока появится реальное ограничение во времени: найти и перехватить, пока можно...

 e) Значок "=" шириной во всю клетку означает "неизменный" секрет. Лучше всего сразу 
расставить в них стены, чтобы не пропустить, и "втягивать" в карту по мере написания... 
как в этом примере.
 f) Квадратики означают вещи, причем цвет кодирует графику, а не "смысловую нагрузку". 
Левым кликом они выделяются (белые), левым кликом по выделенным раскрепляются (синие) 
и, после перемещения, ставятся (снова белые). Средним кликом вещь удаляется, а средний 
клик в пустой клетке копирует туда выделенную вещь. При перемещении "драгом" и создании 
вновь автоматически апдейтится Visspot ptr.
 g) Круглый блин, нестрого связанный с клеточными координатами -- это объект. Он 
ведет себя практически так же, как вещь, но его цвет задается "смысловой нагрузкой", 
типом. Ото всех валидных указателей подслоя "кто стоит" к каждому объекту тянутся 
нити-линки. При копировании объекта авто-апдейтятся указатели, пол (если он там есть) 
и центровка в клетке.
 h) Маленькая скважинка -- дверь. Каждая клетка двери связана с самой дверью, причем 
сама дверь может быть только перемещена, понятия "удаление" для них не существует 
(в отличие от клеток двери). Можно создать две или более клетки двери, и они синхронизируются, 
но физически открываться (т.е. становиться проницаемой) будет только та, в которой 
стоит сама дверь. Более того, если сама дверь стоит где-нибудь в стене, то там, где 
она стоит, проход будет открываться "дистанционно", нажатием на клетку двери.
 12) Имя сохраненки в меню Wolf.
 13) Уровень сложности. Стандартно 0..3, но в каком-нибудь моде и 4 бывает.
 14) Эпизод, к которому относится уровень.
 15) Номер уровня. Слишком большие величины заносят уровень в следующий эпизод, что 
можно умело использовать, а уровень становится секретным и ratios для него не считаются. 
Кнопочка refresh, которую следует нажать после изменения номера уровня и/или эпизода, 
перезагружает "неизменные".
 16) Оставшиеся жизни. Как правило, ставится в ноль, т.к. у игрока всего одна попытка 
на прохождение уровня: после смерти перезагрузится в любом случае стандартный. Бывают 
и отрицательные значения: допустим, вы хотите поместить на уровень "синюю жизнь" 
как источник +99%/+25ammo и хотите при этом скомпенсировать ее "основной" эффект 
как +1 к жизням.
 17) Очки в начале уровня. Выставляются после смерти. См. п. 16.
 18) Текущие очки.
 19) Очки, на которых дается следующая жизнь. Обычно задираются чуть выше тех, которые 
бывают после идеального прохождения уровня (см. п. 16). Если хорошо рассчитать, то 
бонусы за идеальное прохождение уровня отправят игрока на следующий-стандартный уже 
с одной-двумя жизнями (если повезло с par time). Разумное исключение -- уровень, 
не имеющий выхода, но имеющий возможность добрать очков до новой жизни. В таком случае 
конец уровня состоит в том, чтобы набрать одну жизнь и умереть, а затем пройти стандартный, 
имеющий выход уровень. См. "Напутствие" в части тоталконвершна.
 20) Здоровье. Может быть немного выше ста, так, чтобы не глючил фрейм "рожицы". 
Однако первый же бонус вернет его к сотне :(
 21) Боеприпасы. Полезная вещь, помогают жить и делать добрые дела налево и направо 
:)
 22) Ключи. Всего их в стандартной игре 4, но графику имеют только 2. Моды могут 
иметь все 16, так что флаги даны не только для Silver и Golden, но и для "циферных".

 23) Оружие. Лучшее, которое есть (бредовое аркадное решение, получается, что наличие 
пулемета автоматически гарантирует наличие автомата), текущее (в руках), выбранное 
(может не быть в руках, если, скажем, нет патронов. Однако при их появлении тут же 
"возьмется" само).
 24) Мордочка. В принципе, "живет" до следующего поворота глаз, но можно сделать 
ее какой-нибудь нестандартной в качестве "приветствия".
 25) Служебки. Первые три нужны, если вы хотите изобразить оружие с самого начала 
"в полете", в действии. Например, уровень начинается с того, что у дульного среза 
гаснет огонек, а вдалеке падает нацист. Вторая группа относится к DeathCam (tm), 
средней глупости изобретению id, с которым они носились, как с писаной торбой. В 
принципе, "последняя заставка эпизода" и дальнейшая игра мало совместимы... ну да 
кто-нибудь что-нибудь придумает.
 26) Заслуги. Прошедшее с начала уровня время, врагов всего/убито, секретов всего/найдено, 
барахла всего/сперто. Буковка "сигма", надеюсь, понятна всем.
 27) Былые заслуги. Уровень и для него -- время и ratios. В этот раз уже в %.
 28) Черчение стены (подслой "как выглядит"). Флажок "опустить перо", номер стены 
и пара кнопок автоселекции, нажатие на которые автоматически добавляет-вычитает 64 
и 128 так, что стена станосится косяком, опять стеной, дверью, секретной дверью, 
простой стеной...
 29) Черчение препятствий (подслой "кто стоит"). Тоже флажок пера, тоже номер. Иногда 
авто-апдейтится, если равенство его стене принято в стандартных картах.
 30) Указатель на последнюю вещь и индикаторы количества вещей и объектов. Позволяют 
добавлять вещи не средним кликом, а "вручную", смещая этот указатель и наблюдая за 
откликом; см. также п. 38.
 31) Выбор номера вещи. Альтернатива кликанью по карте.
 32) Выбор графического отображения вещи. "И стал наш гусь ни на кого не похож..." 
Можно сделать памятник Гитлеру и поставить среди прочих алюминиевых лыцарей и мисок 
с дерьмом. Можно заставить ключ выглядеть как столик и совместить с другим столиком, 
чтобы после подбирания его ключ-"столик" не исчезал. Вроде как ключ со стола взяли. 
Или братвюрст с печки. Бензин наш -- идеи ваши.
 33) См. п. 1. Апдейтится при перемещении мышкой, создании вновь или нажатии "AUTO". 
Указывает на точку видимости, которая должна соответствовать клетке вещи. Если она 
ей не соответствует (проапдейтили, а потом передвинули "вручную"), то вещь не рисуется, 
если в кадр не попадает эта точка. Отличная тема для злоупотреблений: если перевести 
эту точку куда-нибудь на стенку, вещь будет видна только с одной стороны, когда в 
кадр попадает эта точка. С противоположной, когда точка за спиной, вещь исчезает.

 34) "Вертушки" ручного перемещения вещи.
 35) Что дается при подбирании. Подбираются решительно все вещи, имеющие флажок "Bonus", 
только их суть определяется отнюдь не внешним видом. Суть определяется этим пунктом, 
и вещь может дать неожиданный результат (например, Копьё Судьбы -- бонус к здоровью) 
или подбираться, не давая вообще ничего. Скажем, вы можете продираться через корни 
таким методом (за спиной у вас останется проход), или что-нибудь раздавить.
 36) Флаги. Общие для вещей и объектов, флаги обводятся рамочкой по принадлежности 
в зависимости от того, что вы редактируете. Однако флаг "восприимчив к пулям", например, 
не работает для вещей, объект не может быть "бонусом" и т. п. -- до Doom'овских обобщений 
SObj/MObj еще далеко. Флаг "глухой" очевиден по действию, а остальные 5 отсылают 
нас к чтению исходников.
 37) П. 31 применительно к объекту.
 38) Указатель активности. Неактивный объект ждет, пока его потревожат, активный 
-- топает кругами или бежит нас рвать на сотню маленьких медвежат (и рвется обычно 
сам). "-1" в этом пункте означает, что перед нами не объект вовсе, а несчастный маркер 
конца списка. Переделав его в 0/1 и следующий за ним -- в -1, мы добавим в список 
таки целый объект. Вручную, без среднего клика, типа как настоящие кулхацкеры :)

 39) Счетчик тиков объекта. Таймер перехода от состояния к состоянию.
 40) Тип объекта. Игрок, фриц, курц, гейнц, румпельштильхен, кабысдох кусачий, блинки, 
пинки, инки, клайд, медный фюрер... Истинная сущность, короче. Игрок всегда 0-й, 
в самом начале. И ссылки на него в подслое "кто стоит" нету. Может быть, нарушение 
этих правил тоже что-нибудь интересное дает.
 41) Текущий кадр, или фрейм. Нынешнее состояние -- лежит ли мертвый, бежит ли, стреляет 
ли. За некоторыми фреймами автоматически идут другие (бег, скажем), за некоторыми 
-- никаких (лежание мертвым). Мы можем жестоко надругаться над игроком, поставив 
живому рядовому фрейм "мертый рядовой" -- и он будет лежать и притворяться, пока 
в него случайно не попадут пулей; или даже мы можем поставить псу фрейм "стоящий 
рядовой" -- и завидев нас, человек превратится в оборотня и ринется нас жрать.
 Откуда взять их номера? Из образцовых сейвов.
 42) Дистанция. Расстояние до центра следующей клетки, куда идет объект. Отрицательная 
величина означает, что он дернул дверь и ждет, пока она откроется. Для центрованных 
объектов -- вроде бы ноль, ну и да будет так, чтобы не скосячить. Хотя сценки типа 
"спьяну в дверь попасть не может, то в левый, то в правый косяк тычется" могли бы 
быть интересными. Сил нет тестить ВСЕ возможные эффекты.
 43) Направление. 9 вариантов: стороны, диагонали и "стой, скотина, смотри во все 
стороны сразу". Для неразумных тварей, т.е. NPC.
 44) Номер пола. Именно этой величиной, а вовсе не реальным расположением, определяется 
для стоящих противников номер того пола, из которого они слышат шум. Естественно, 
топающие рано или поздно куда-нибудь притопают и обновят этот параметр.
 45) Клеточные координаты. Нажатие "->" центрует истинные координаты согласно клеточным. 
Кстати, "вертушки" -- единственный способ вынести вещь или объект по Y за пределы 
диапазона 0..63, что приводит к "переполнению" в Х и "закольцовыванию" карты по Y 
со сдвигом на единицу по Х.
 46) Истинные координаты в точной координатной системе. Давайте будем честными: на 
редкость через жопу сделана в Wolfenstein 3-D система координат и система движения 
противников. На редкость.
 47, 48, 49) Рендеринговые параметры. Вроде бы и нам-то не нужны -- сами рефрешатся.

 50) Угол. Заменяет нормальным, имеющим мозги существам направление из п. 43.
 51) Здоровье. Тоже только для неразумных тварей. Дааа, с унификацией совсем плохо... 
Понятно, почему сетевая игра появилась только в Doom.
 52) Скорость. Очень полезный параметр. Особенно стильно задирать ее "до потолка" 
монстрам и собачкам.
 53) Три темпа. Может, в них что-то полезное пишет какой-нибудь мод.
 54) Поинтеры на предыдущий и следующий объект. Сохраняются, но не загружаются. Может 
быть, в моде, случайно...
 55) Номер двери. Очень полезный селектор, в отличие от: двери обычно берутся по 
очереди, и перебирать все скважинки не слишком-то удобно. Правда, скважинка не белеет 
(мея кульпа...) и после селекции как минимум начало работы приходится проводить "вертушками", 
а не кликом-драгом.
 56) Вертушки координат. См. п. 55.
 57) "Угол". Насчет модов не знаю, но в оригинале -- только горизонтальная или вертикальная. 
Единственное (?), на что это влияет -- это на то, становятся звукосмежными при открывании 
пол сверху-снизу от двери или слева-справа. Поэтому горизонтальная дверь в горизонтальном 
проходе -- явление вполне нормальное, если проход в нестандартном месте и должен 
соединить два пола сверху и снизу.
 58) Тип ключа. 0 -- никакого, 1..4 -- 4 стандартных, 5 -- опять же никакого, зовется 
"лифт", остальные валят рендеринг.
 59) Состояние. Закрыто, открыто, едет туда-сюда.
 60) Сколько она уже стоит открытой и не пора ли ей...
 61) На сколько голубушка отъехала. Архиполезно для "мертвых" дверей-украшений.
 62) Состояние "секрета". Эта величина отображает пройденный им всего путь.
 63) Никогда не замечали, что секрет одновремено можно открывать только один? Это 
потому, что секретная "дверь" только одна -- вот она. Она "прыгает" туда, где открывается 
блок, и вот ее координаты.
 64) Направление уползания блока.
 65) Текущая позиция. По умолчанию 63 -- "углубился до конца". После того, как где-то 
открыли секрет и эта позиция проделала путь от 0 до 63 по каждой из клеток пути, 
снова остается на 63-й точке. Стало быть, если вы сделаете где-нибудь в тонкой стене 
одну клетку с номером 193 и выше ("секрет"), с обеих сторон стены она будет выглядеть 
как ниша глубиной в целую клетку. Эдакий гиперпространственный проем... займите его 
вазочкой, к примеру. Только следите, чтобы поблизости секретов не было: когда один 
из них "поедет", поедет и ваша ниша-обманка.
 Это же можно и использовать: к примеру, в начале уровня может удаляться пейзаж, 
если уровень имитирует поезд.
 66) Селектор номера пола.
 67) Флаг, слышат ли вас на этом полу. 0 или 1. Часто из-за какой-то ошибки указателя 
забивается единицами, вспугивая не тех и не тогда :(
 68) Перечень всех полов с указанием, с какими данный пол звукосмежен. "0" -- не 
звукосмежен, "1" -- между ними открыта одна дверь, "2" -- между ними открыто две 
двери и т.п.

Напутствие.

 Недокументированные эффекты движка, ради которых, собственно, редактор и писался, 
регулярно приводят к сбоям указателей, а это, по сути, можут вызвать любую ошибку 
любого рода. Рекомендую скармливать движку "недоки" маленькими порциями, и начинать 
"разбирательство" при любых, даже самых незначительных, симптомах.
 Лучший вид адд-она с участием SaveGam?.* Editor -- это, как я считаю, тоталконвершн, 
где карты пишутся с изначально заложенной "двувариантностью". Первый вариант, загружаемый 
стандартно, проходится последовательно и некоторые элементы в нем остаются незадействованы, 
будучи скрыты стенами (например, "неизменяемый" выход с эпизода). Ну, а помимо этого 
прилагаются мини-эпизоды с одним уровнем и жизнью, реализованные при помощи SaveGam?.* 
Editor'а, которые совершенно не похожи на своих "внутриэпизодных" братьев и имеют 
собственный выход.
 Второй, также очень хороший способ удивить народ -- мини-эпизоды к стандартным Wolf3D 
и SoD, "сохраненки из ниоткуда". И, честно говоря, очень хочется самому ознакомиться 
с плодами вашей фантазии. Поиграть в них, проще говоря.
Николай Коровин